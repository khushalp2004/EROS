import React from "react";
import { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from "react-leaflet";
import L from "leaflet";
import "leaflet/dist/leaflet.css";

// Fix missing marker icons when using bundlers (CRA/Vite)
import markerIcon2x from "leaflet/dist/images/marker-icon-2x.png";
import markerIcon from "leaflet/dist/images/marker-icon.png";
import markerShadow from "leaflet/dist/images/marker-shadow.png";

L.Icon.Default.mergeOptions({
  iconRetinaUrl: markerIcon2x,
  iconUrl: markerIcon,
  shadowUrl: markerShadow,
});

const ambulanceIcon = L.divIcon({
  className: "ambulance-icon",
  html: '<div style="font-size:20px; line-height:20px;">ðŸš‘</div>',
  iconSize: [24, 24],
  iconAnchor: [12, 12],
});
const defaultIcon = new L.Icon.Default();

function MapAutoCenter({ center }) {
  const map = useMap();
  React.useEffect(() => {
    if (center) {
      map.setView(center, map.getZoom(), { animate: true });
    }
  }, [center, map]);
  return null;
}

function MapView({ markers, center, polylines = [] }) {
  const defaultCenter = [19.076, 72.8777];
  const mapCenter = center || (markers.length === 1
    ? [markers[0].latitude, markers[0].longitude]
    : defaultCenter);
  const mapZoom = markers.length === 1 ? 14 : 12;

  if (!markers || markers.length === 0) {
    return <p style={{ marginTop: "10px" }}>No locations to display.</p>;
  }

  return (
    <MapContainer
      key={`${mapCenter[0]}-${mapCenter[1]}-${mapZoom}-${markers.length}`}
      center={mapCenter}
      zoom={mapZoom}
      style={{ height: "500px" }}
    >
      {center && <MapAutoCenter center={center} />}
      <TileLayer
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />
      {markers.map((m, i) => (
        <Marker
          key={i}
          position={[m.latitude, m.longitude]}
          icon={m.isSimulated ? ambulanceIcon : defaultIcon}
          zIndexOffset={m.isSimulated ? 500 : 0}
        >
          <Popup>
            {m.type} - Status: {m.status}
          </Popup>
        </Marker>
      ))}
      {polylines.map((pl, idx) => (
        <Polyline
          key={idx}
          positions={pl.positions}
          pathOptions={{ color: pl.color || "blue", weight: 4, opacity: 0.6, dashArray: pl.dash ? "6 6" : null }}
        />
      ))}
    </MapContainer>
  );
}

export default MapView;
